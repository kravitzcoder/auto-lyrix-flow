name: AutoLyrixAlign Processing
on:
  repository_dispatch:
    types: [align-lyrics]

jobs:
  align-lyrics:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
    
    - name: Install dependencies
      run: |
        pip install librosa torch transformers
        sudo apt-get update
        sudo apt-get install -y ffmpeg
    
    - name: Download AutoLyrixAlign model
      run: |
        # Download pre-trained model
        wget -O model.zip "https://drive.google.com/uc?export=download&id=1zJdhPr9SzTVRXIaiZ7eF_QKN0PT2sbIW"
        unzip model.zip
    
    - name: Process alignment
      run: |
        python align_lyrics.py \
          --audio "${{ github.event.client_payload.audio_url }}" \
          --lyrics "${{ github.event.client_payload.lyrics_text }}" \
          --output-format "${{ github.event.client_payload.format }}"
    
    - name: Upload results
      uses: actions/upload-artifact@v3
      with:
        name: aligned-lyrics-${{ github.event.client_payload.job_id }}
        path: output/
